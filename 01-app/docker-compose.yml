version: '3.8'

services:
  # 主应用服务
  app:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/arm64
    image: ascend-npu-app:latest
    container_name: ascend-npu-server
    restart: unless-stopped
    ports:
      - "9999:9999"
    environment:
      - PYTHONUNBUFFERED=1
      - ASCEND_VISIBLE_DEVICES=0
      - ASCEND_RT_VISIBLE_DEVICES=0
    volumes:
      # 挂载昇腾驱动和库
      - /usr/local/Ascend/driver/lib64:/usr/local/Ascend/driver/lib64:ro
      - /usr/local/Ascend/driver/tools:/usr/local/Ascend/driver/tools:ro
      - /usr/local/Ascend/driver/hdc:/usr/local/Ascend/driver/hdc:ro
      - /usr/local/Ascend/driver/libc_sec:/usr/local/Ascend/driver/libc_sec:ro
      # 挂载日志目录
      - ./logs:/app/logs
      # 挂载模型目录
      - ./models:/app/models
      # 挂载数据目录
      - ./data:/app/data
    devices:
      # 挂载NPU设备（昇腾310）
      - /dev/davinci0:/dev/davinci0
      - /dev/davinci_manager:/dev/davinci_manager
      - /dev/devmm_svm:/dev/devmm_svm
      - /dev/hisi_hdc:/dev/hisi_hdc
    networks:
      - ascend-network
    # 使用gunicorn启动高并发服务
    command: >
      gunicorn -w 4 
      -k gevent 
      --bind 0.0.0.0:9999 
      --timeout 120 
      --keep-alive 5 
      --max-requests 1000 
      --max-requests-jitter 50
      --access-logfile /app/logs/access.log
      --error-logfile /app/logs/error.log
      --log-level info
      app:app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9999/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 可选：TensorBoard服务
  tensorboard:
    build:
      context: .
      dockerfile: Dockerfile
    image: ascend-npu-app:latest
    container_name: ascend-tensorboard
    restart: unless-stopped
    ports:
      - "6006:6006"
    volumes:
      - ./logs:/app/logs
      - ./models:/app/models
    command: tensorboard --logdir=/app/logs --host=0.0.0.0 --port=6006
    networks:
      - ascend-network
    profiles:
      - monitoring

  # 可选：Jupyter Notebook服务
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    image: ascend-npu-app:latest
    container_name: ascend-jupyter
    restart: unless-stopped
    ports:
      - "8888:8888"
    environment:
      - PYTHONUNBUFFERED=1
      - ASCEND_VISIBLE_DEVICES=0
    volumes:
      - ./:/app/workspace
      - ./models:/app/models
      - ./data:/app/data
    devices:
      - /dev/davinci0:/dev/davinci0
      - /dev/davinci_manager:/dev/davinci_manager
      - /dev/devmm_svm:/dev/devmm_svm
    networks:
      - ascend-network
    command: >
      jupyter notebook 
      --ip=0.0.0.0 
      --port=8888 
      --no-browser 
      --allow-root 
      --NotebookApp.token='' 
      --NotebookApp.password=''
    profiles:
      - dev

networks:
  ascend-network:
    driver: bridge
