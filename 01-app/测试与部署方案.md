# 测试与内网部署方案

## 一、功能测试

### 1. 测试脚本说明

#### `tests/test_all.py` - 完整测试套件
包含5个测试类：
- **TestNLPInference**: 测试NLP推理功能
  - 单条预测测试
  - 批量预测测试
  - 多类型文本测试
  
- **TestNLPTraining**: 测试NLP训练功能
  - 训练器初始化测试
  - 训练流程测试
  - 评估功能测试
  
- **TestOCRInference**: 测试OCR推理功能
  - OCR引擎初始化测试
  - 图片识别测试
  - 字节数据识别测试
  
- **TestOCRTraining**: 测试OCR训练功能
  - 训练器初始化测试
  - 数据集准备测试
  - 配置文件生成测试
  
- **TestAPIIntegration**: 测试API集成
  - NLP推理API测试
  - 健康检查API测试
  - NPU状态API测试

#### `tests/test_functional.py` - 功能测试
快速验证核心功能：
- 依赖导入检查
- NLP基础功能
- OCR基础功能
- Flask应用测试
- NPU检测

### 2. 运行测试

```bash
# 快速功能测试
./run-tests.sh

# 或单独运行
python3 tests/test_functional.py

# 完整测试套件
python3 tests/test_all.py
```

## 二、多架构构建方案

### 支持的架构

| 架构 | 说明 | NPU支持 | 构建脚本 |
|------|------|---------|----------|
| ARM64 (aarch64) | 昇腾服务器 | ✅ 支持NPU | `scripts/build-arm.sh` |
| x86_64 (amd64) | 普通服务器 | ❌ 仅CPU | `scripts/build-x86.sh` |

### 1. ARM64架构构建（带NPU）

```bash
# 在ARM64机器上执行
./scripts/build-arm.sh

# 生成镜像
# - ascend-npu-app:1.0.0-arm64
# - ascend-npu-app:latest-arm64
```

**使用方式:**
```bash
# 带NPU设备运行
docker run -d --name ascend-app \
  --device /dev/davinci0 \
  --device /dev/davinci_manager \
  --device /dev/devmm_svm \
  -p 9999:9999 \
  ascend-npu-app:1.0.0-arm64
```

### 2. x86_64架构构建

```bash
# 在x86机器上执行
./scripts/build-x86.sh

# 生成镜像
# - ascend-npu-app:1.0.0-amd64
# - ascend-npu-app:latest-amd64
```

**使用方式:**
```bash
# CPU模式运行
docker run -d --name ascend-app \
  -p 9999:9999 \
  ascend-npu-app:1.0.0-amd64
```

### 3. 多架构同时构建（需要Docker Buildx）

```bash
./scripts/build-multiarch.sh

# 生成多架构镜像
# - ascend-npu-app:1.0.0（自动选择架构）
```

## 三、内网离线部署方案

### 方案概述

适用于无外网连接的内网环境，需要在外网机器上预先打包所有依赖，然后传输到内网部署。

### 外网打包步骤

```bash
# 1. 运行打包脚本
./scripts/package-offline.sh

# 2. 打包结果
# ascend-npu-app-offline-1.0.0-aarch64-YYYYMMDD.tar.gz
# 或
# ascend-npu-app-offline-1.0.0-amd64-YYYYMMDD.tar.gz
```

**打包内容:**
```
离线安装包/
├── docker-images/          # Docker镜像
│   ├── ascend-npu-app.tar
│   └── ubuntu-22.04.tar
├── python-packages/        # Python依赖（所有whl包）
├── app.py                  # 主应用
├── examples/               # 示例代码
├── tests/                  # 测试代码
├── docker-compose.yml      # Docker编排
├── *.sh                    # 脚本文件
├── install.sh             # 安装脚本（自动生成）
└── docs/                   # 文档
    ├── 内网部署指南.md
    └── 依赖清单.txt
```

### 内网部署步骤

#### 方式1: 使用自动导入脚本

```bash
# 1. 传输安装包到内网
scp ascend-npu-app-offline-1.0.0-arm64-*.tar.gz user@internal-server:/opt/

# 2. 解压
ssh user@internal-server "cd /opt && tar -xzf ascend-npu-app-offline-1.0.0-arm64-*.tar.gz"

# 3. 运行导入脚本
ssh user@internal-server "cd /opt/ascend-npu-app-offline-* && sudo ./scripts/import-offline.sh"

# 4. 启动服务
ssh user@internal-server "sudo systemctl start ascend-npu-app"
```

#### 方式2: 手动部署

```bash
# 1. 解压
tar -xzf ascend-npu-app-offline-1.0.0-arm64-*.tar.gz
cd ascend-npu-app-offline-*/

# 2. 加载Docker镜像
for img in docker-images/*.tar; do
    sudo docker load < "$img"
done

# 3. 安装Python依赖
sudo pip3 install --no-index --find-links=python-packages -r requirements.txt

# 4. 复制文件并启动
sudo cp -r . /opt/ascend-npu-app/
cd /opt/ascend-npu-app
sudo ./start.sh
```

### 目录结构对比

**外网开发环境:**
```
01-app/
├── app.py
├── Dockerfile
├── docker-compose.yml
├── requirements.txt
├── examples/
├── tests/
├── scripts/
│   ├── package-offline.sh
│   ├── import-offline.sh
│   ├── build-arm.sh
│   └── build-x86.sh
├── readme.md
└── setup.sh
```

**内网部署环境:**
```
/opt/ascend-npu-app/
├── app.py
├── docker-compose.yml
├── examples/
├── tests/
├── models/              # 模型文件（运行时生成）
├── data/                # 数据文件
├── logs/                # 日志文件
└── *.sh
```

## 四、快速开始指南

### 场景1: 外网开发测试

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 运行测试
./run-tests.sh

# 3. 启动服务
./start.sh

# 4. 测试API
curl http://localhost:9999/health
```

### 场景2: ARM64生产部署（有网络）

```bash
# 1. 构建镜像
./scripts/build-arm.sh

# 2. 启动（带NPU）
docker-compose up -d

# 3. 验证
curl http://localhost:9999/npu/status
```

### 场景3: 内网离线部署

```bash
# 【外网机器】
# 打包
./scripts/package-offline.sh

# 【传输到内网】
# 使用U盘/硬盘/网络传输

# 【内网机器】
# 导入并安装
tar -xzf ascend-npu-app-offline-*.tar.gz
cd ascend-npu-app-offline-*
sudo ./scripts/import-offline.sh

# 启动
sudo systemctl start ascend-npu-app
```

## 五、常见问题

### Q1: 如何确定使用哪个架构？

```bash
# 查看系统架构
uname -m

# aarch64  -> ARM64（使用arm64版本）
# x86_64   -> x86（使用amd64版本）
```

### Q2: 内网部署时缺少Docker怎么办？

打包时包含Docker安装包：
```bash
# 在外网下载Docker安装包
mkdir -p docker-packages
cd docker-packages

# Ubuntu
apt-get download docker-ce docker-ce-cli containerd.io

# CentOS
yumdownloader docker-ce docker-ce-cli containerd.io

# 打包时包含docker-packages目录
```

### Q3: 如何验证离线包完整性？

```bash
# 检查MD5校验
md5sum -c ascend-npu-app-offline-*.tar.gz.md5

# 检查文件列表
tar -tzf ascend-npu-app-offline-*.tar.gz | head -20
```

### Q4: 升级内网部署版本？

```bash
# 1. 备份现有数据
cp -r /opt/ascend-npu-app/models /backup/models-$(date +%Y%m%d)

# 2. 导入新版本
sudo ./scripts/import-offline.sh

# 3. 恢复数据
sudo systemctl stop ascend-npu-app
cp -r /backup/models-*/* /opt/ascend-npu-app/models/
sudo systemctl start ascend-npu-app
```

## 六、目录清单

### 新增文件清单

| 文件路径 | 说明 |
|---------|------|
| `tests/test_all.py` | 完整测试套件 |
| `tests/test_functional.py` | 功能测试脚本 |
| `tests/__init__.py` | 测试模块初始化 |
| `run-tests.sh` | 快速测试入口 |
| `Dockerfile.multiarch` | 多架构Dockerfile |
| `scripts/package-offline.sh` | 离线打包脚本 |
| `scripts/import-offline.sh` | 离线导入脚本 |
| `scripts/build-multiarch.sh` | 多架构构建脚本 |
| `scripts/build-arm.sh` | ARM架构构建脚本 |
| `scripts/build-x86.sh` | x86架构构建脚本 |
| `deploy/离线部署清单.md` | 部署清单文档 |
| `offline-packages/` | 离线包输出目录 |

### 使用方法总结

```bash
# 测试
./run-tests.sh

# 构建（选择对应架构）
./scripts/build-arm.sh      # ARM64
./scripts/build-x86.sh      # x86_64
./scripts/build-multiarch.sh # 多架构

# 打包（外网）
./scripts/package-offline.sh

# 导入（内网）
./scripts/import-offline.sh
```
