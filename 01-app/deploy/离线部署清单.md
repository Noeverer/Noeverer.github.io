# 内网离线部署清单

## 外网打包环境准备（有网络连接的机器）

### 1. 安装基础软件
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y docker.io docker-compose python3-pip

# CentOS/RHEL
sudo yum install -y docker docker-compose python3-pip
```

### 2. 下载Docker镜像
```bash
# 拉取基础镜像
docker pull ubuntu:22.04

# 构建应用镜像
docker build -t ascend-npu-app:1.0.0 -f Dockerfile.multiarch .

# 保存镜像
mkdir -p docker-images
docker save ubuntu:22.04 > docker-images/ubuntu-22.04.tar
docker save ascend-npu-app:1.0.0 > docker-images/ascend-npu-app-1.0.0.tar
```

### 3. 下载Python依赖
```bash
# 创建虚拟环境
python3 -m venv venv_download
source venv_download/bin/activate

# 下载依赖
pip download -r requirements.txt -d python-packages

# 打包
tar -czf python-packages.tar.gz python-packages/
```

### 4. 准备安装包
```bash
# 创建安装包目录
mkdir -p ascend-npu-app-offline
cp -r app.py examples tests docker-compose.yml *.sh readme.md ascend-npu-app-offline/
cp -r docker-images python-packages ascend-npu-app-offline/

# 创建安装脚本
cat > ascend-npu-app-offline/install.sh << 'EOF'
#!/bin/bash
# 内网安装脚本
echo "开始内网安装..."
# 加载镜像
for img in docker-images/*.tar; do
    docker load < "$img"
done
# 复制文件
cp -r . /opt/ascend-npu-app/
cd /opt/ascend-npu-app
# 启动
./start.sh
EOF
chmod +x ascend-npu-app-offline/install.sh

# 打包
tar -czf ascend-npu-app-offline.tar.gz ascend-npu-app-offline/
```

## 传输到内网

### 使用U盘/移动硬盘
```bash
# 复制到U盘
cp ascend-npu-app-offline.tar.gz /media/usb/

# 在内网机器上挂载并复制
mkdir -p /mnt/usb
mount /dev/sdb1 /mnt/usb
cp /mnt/usb/ascend-npu-app-offline.tar.gz /opt/
```

### 使用scp（如果有临时网络）
```bash
# 从外网传输到跳板机
scp ascend-npu-app-offline.tar.gz user@jump-server:/tmp/

# 从跳板机传输到内网
scp /tmp/ascend-npu-app-offline.tar.gz user@internal-server:/opt/
```

## 内网部署步骤

### 1. 解压安装包
```bash
cd /opt
tar -xzf ascend-npu-app-offline.tar.gz
cd ascend-npu-app-offline
```

### 2. 安装Docker（如未安装）
```bash
# Ubuntu/Debian
sudo dpkg -i docker-packages/*.deb

# CentOS/RHEL
sudo rpm -ivh docker-packages/*.rpm

sudo systemctl start docker
sudo systemctl enable docker
```

### 3. 加载Docker镜像
```bash
for img in docker-images/*.tar; do
    sudo docker load < "$img"
done
```

### 4. 安装Python依赖
```bash
sudo python3 -m pip install --no-index --find-links=python-packages -r requirements.txt
```

### 5. 启动服务
```bash
sudo ./install.sh
# 或手动启动
cd /opt/ascend-npu-app
sudo ./start.sh
```

## 目录结构

```
ascend-npu-app-offline/
├── docker-images/          # Docker镜像
│   ├── ubuntu-22.04.tar
│   └── ascend-npu-app-1.0.0.tar
├── python-packages/        # Python依赖
│   ├── torch-2.0.1-xxx.whl
│   ├── transformers-4.30.2-py3-none-any.whl
│   └── ...
├── docker-packages/        # Docker安装包（可选）
│   ├── docker-ce_xxx.deb
│   └── ...
├── app.py                  # 主应用
├── examples/               # 示例代码
│   ├── nlp_inference.py
│   ├── nlp_training.py
│   ├── ocr_inference.py
│   └── ocr_training.py
├── tests/                  # 测试代码
├── docker-compose.yml      # Docker编排
├── start.sh               # 启动脚本
├── install.sh             # 安装脚本
└── readme.md              # 说明文档
```

## 验证安装

```bash
# 检查Docker镜像
docker images

# 检查服务
docker-compose ps

# 测试API
curl http://localhost:9999/health

# 运行测试
python3 tests/test_functional.py
```

## 故障排查

### 问题1: Docker加载镜像失败
```bash
# 检查镜像文件完整性
md5sum docker-images/*.tar

# 检查Docker版本
docker --version

# 手动加载测试
docker load < docker-images/ascend-npu-app-1.0.0.tar
```

### 问题2: Python依赖安装失败
```bash
# 检查Python版本
python3 --version  # 需要3.10+

# 单独安装测试
pip install --no-index --find-links=python-packages flask

# 查看缺失包
pip install --no-index --find-links=python-packages -r requirements.txt 2>&1 | grep "not found"
```

### 问题3: 端口冲突
```bash
# 修改端口
cd /opt/ascend-npu-app
sed -i 's/9999:9999/8080:9999/g' docker-compose.yml
docker-compose up -d
```

## 注意事项

1. **架构一致性**: 确保外网打包机器和内网部署机器架构相同（都是ARM64或x86_64）

2. **存储空间**: 确保内网机器有足够的磁盘空间（至少20GB）

3. **权限**: 部署需要root权限

4. **SELinux**: 如果开启SELinux，可能需要额外配置

5. **防火墙**: 确保防火墙允许9999端口访问
